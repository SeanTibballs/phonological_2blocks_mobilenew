<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phonological Similarity & Eye Condition – 2 Blocks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: #f5f5f7;
      color: #222;
    }

    h1, h2, h3 {
      margin-top: 0.3em;
      margin-bottom: 0.4em;
    }

    h1 {
      font-size: 1.6rem;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .step-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #666;
      margin-bottom: 4px;
    }

    label {
      font-weight: 600;
    }

    input[type="number"], input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-top: 4px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }

    .btn {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      margin: 4px 4px 4px 0;
      background: #007aff;
      color: white;
      text-align: center;
    }

    .btn.secondary {
      background: #e5e5ea;
      color: #222;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .flex {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .sequence-display {
      font-size: 2.4rem;
      font-weight: 700;
      letter-spacing: 0.25em;
      text-align: center;
      padding: 18px 10px;
      border-radius: 10px;
      background: #111827;
      color: #f9fafb;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .small-note {
      font-size: 0.8rem;
      color: #666;
    }

    .grid-row {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .grid-row input {
      text-align: center;
      padding: 8px 2px;
      font-size: 1rem;
      text-transform: uppercase;
    }

    .status {
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.85rem;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: center;
    }

    th {
      background: #f0f0f5;
    }

    .worksheet-grid {
      margin-top: 8px;
      overflow-x: auto;
    }

    .worksheet-grid table {
      width: auto;
      border-collapse: collapse;
    }

    .worksheet-grid th,
    .worksheet-grid td {
      width: 32px;
      height: 28px;
      font-size: 0.8rem;
    }

    .worksheet-grid .row-label {
      background: #f0f0f5;
      font-weight: 600;
    }

    .worksheet-grid .letter-cell {
      background: #ffffff;
    }

    .worksheet-grid .rhyming-cell {
      background: #ffe6e6;
      font-weight: 600;
    }

    .worksheet-grid .non-rhyming-cell {
      background: #e7f6ea;
    }

    .eye-instruction {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    @media (max-width: 600px) {
      body {
        padding: 8px;
      }

      .card {
        padding: 12px;
      }

      h1 {
        font-size: 1.4rem;
      }

      .sequence-display {
        font-size: 2rem;
        padding: 14px 8px;
        letter-spacing: 0.2em;
      }

      .grid-row {
        gap: 2px;
      }

      .grid-row input {
        padding: 6px 2px;
        font-size: 0.95rem;
      }

      .btn {
        width: 100%;
        margin-right: 0;
      }

      .flex {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <h1>Phonological Similarity & Eye Condition</h1>
  <p class="small-note">
    IV1: phonological similarity (rhyming vs non-rhyming letters, both eyes open only)<br>
    IV2: eye condition (both eyes open, right eye closed, left eye closed)<br>
    DV: number of recall errors.
  </p>

  <!-- STEP 1: SETUP -->
  <div class="card" id="step1">
    <div class="step-label">Step 1</div>
    <h2>Set up the experiment</h2>
    <div class="flex">
      <div style="flex: 1 1 160px;">
        <label for="exposureTime">Exposure time per row (seconds):</label>
        <input type="number" id="exposureTime" min="1" max="20" value="5" />
      </div>
      <div style="flex: 1 1 160px;">
        <label for="participantId">Participant ID / initials:</label>
        <input type="text" id="participantId" placeholder="e.g., P01" />
      </div>
    </div>
    <p class="small-note">
      Rhyming letters: B, C, D, G, P, T. &nbsp; Non-rhyming letters: H, F, M, Q, R, S, Z.
    </p>
    <button class="btn" id="goToStep2">Continue to Step 2</button>
  </div>

  <!-- STEP 2: RUN BLOCKS -->
  <div class="card" id="step2" style="display:none;">
    <div class="step-label">Step 2</div>
    <h2>Run the blocks</h2>
    <p class="small-note">
      Block 1: Both eyes open (rows 1–10).<br>
      Block 2: Alternating eye closure (rows 1–10):<br>
      &nbsp;&nbsp;• Odd rows (1,3,5,7,9): right eye closed, left eye open<br>
      &nbsp;&nbsp;• Even rows (2,4,6,8,10): left eye closed, right eye open
    </p>

    <div class="flex" style="margin-bottom: 8px;">
      <button class="btn" id="startBothBlock">Start Block 1: Both eyes open</button>
      <button class="btn" id="startAltBlock">Start Block 2: Alternating eyes</button>
      <button class="btn secondary" id="resetExperiment">Reset everything</button>
    </div>

    <p class="status" id="blockStatus">No block running yet.</p>

    <!-- Letter grid (shown only when no block is running) -->
    <div class="worksheet-grid" id="worksheetGridContainer">
      <h3>Letter rows (for the experimenter only)</h3>
      <div id="worksheetGrid"></div>
      <p class="small-note">
        Once a block starts, this grid is hidden so the participant cannot see the answers.
      </p>
    </div>

    <!-- Trial area (only visible during trials) -->
    <div id="trialArea">
      <div id="sequenceContainer" style="display:none;">
        <div class="sequence-display" id="sequenceDisplay"></div>
        <p class="small-note">
          Show this sequence while the participant uses the instructed eye condition.
        </p>
      </div>

      <div id="inputContainer" style="display:none;">
        <div class="eye-instruction" id="eyeInstruction"></div>
        <h3>Type the letters in order</h3>
        <p class="small-note">
          One letter per box, left to right.
        </p>
        <div class="grid-row" id="responseGrid"></div>
        <button class="btn" id="submitTrial">Submit this row</button>
        <p class="small-note" id="timerStatus"></p>
      </div>
    </div>
  </div>

  <!-- STEP 3: RESULTS -->
  <div class="card" id="step3" style="display:none;">
    <div class="step-label">Step 3</div>
    <h2>View results</h2>
    <p class="small-note">
      IV1 is based only on Block 1 (both eyes open). IV2 uses all eye conditions.
    </p>

    <h3>IV1: Phonological similarity (both eyes open only)</h3>
    <div id="iv1SummaryContainer"></div>

    <h3>IV2: Eye condition × phonological similarity</h3>
    <div id="summaryContainer"></div>

    <h3>Trial-by-trial data</h3>
    <div id="trialTableContainer" style="max-height: 260px; overflow: auto;"></div>
    <button class="btn" id="downloadCsv">Download CSV</button>
  </div>

  <script>
    // ====== CONFIG: LETTER SEQUENCES FROM WORKSHEET ======
    var sequences = [
      ["H","S","F","Q","B","C","D","P"], // 1
      ["G","D","B","T","Z","H","R","S"], // 2
      ["Q","M","Z","R","C","P","D","G"], // 3
      ["T","P","C","B","F","M","Q","Z"], // 4
      ["F","R","Z","S","B","P","G","T"], // 5
      ["C","G","B","P","M","Q","H","R"], // 6
      ["H","Q","R","M","C","T","D","B"], // 7
      ["D","P","T","C","R","Z","F","H"], // 8
      ["M","R","H","Z","C","G","B","T"], // 9
      ["B","T","G","P","R","F","M","S"]  // 10
    ];

    var rhymingLetters    = ["B", "C", "D", "G", "P", "T"];
    var nonRhymingLetters = ["H", "F", "M", "Q", "R", "S", "Z"];

    // ====== STATE ======
    var currentBlock = null; // { blockType, startIndex, endIndex, currentIndex }
    var exposureMs = 5000;
    var trials = [];
    var showingTimeout = null;

    // ====== DOM ELEMENTS ======
    var step1 = document.getElementById("step1");
    var step2 = document.getElementById("step2");
    var step3 = document.getElementById("step3");

    var exposureInput    = document.getElementById("exposureTime");
    var participantInput = document.getElementById("participantId");
    var goToStep2Btn     = document.getElementById("goToStep2");

    var startBothBtn  = document.getElementById("startBothBlock");
    var startAltBtn   = document.getElementById("startAltBlock");
    var resetBtn      = document.getElementById("resetExperiment");
    var submitTrialBtn = document.getElementById("submitTrial");
    var downloadCsvBtn = document.getElementById("downloadCsv");

    var blockStatus        = document.getElementById("blockStatus");
    var sequenceContainer  = document.getElementById("sequenceContainer");
    var sequenceDisplay    = document.getElementById("sequenceDisplay");
    var inputContainer     = document.getElementById("inputContainer");
    var eyeInstructionEl   = document.getElementById("eyeInstruction");
    var responseGrid       = document.getElementById("responseGrid");
    var timerStatus        = document.getElementById("timerStatus");
    var iv1SummaryContainer = document.getElementById("iv1SummaryContainer");
    var summaryContainer   = document.getElementById("summaryContainer");
    var trialTableContainer = document.getElementById("trialTableContainer");
    var worksheetGrid      = document.getElementById("worksheetGrid");
    var worksheetGridContainer = document.getElementById("worksheetGridContainer");

    // ====== BASIC HELPERS ======
    function setBlockStatus(text) {
      blockStatus.textContent = text;
    }

    function clearTimer() {
      if (showingTimeout) {
        clearTimeout(showingTimeout);
        showingTimeout = null;
      }
      timerStatus.textContent = "";
    }

    function resetTrialUI() {
      clearTimer();
      sequenceContainer.style.display = "none";
      inputContainer.style.display = "none";
      eyeInstructionEl.textContent = "";
      var inputs = responseGrid.querySelectorAll("input");
      for (var i = 0; i < inputs.length; i++) {
        inputs[i].value = "";
      }
    }

    function getEyeConditionLabel(code) {
      if (code === "both_open") return "Both eyes open";
      if (code === "right_closed") return "Right eye closed (left eye open)";
      return "Left eye closed (right eye open)";
    }

    function getBlockName(blockType) {
      if (blockType === "both_open_block") return "Block 1 (Both eyes open)";
      return "Block 2 (Alternating eyes)";
    }

    // ====== BUILD STATIC ELEMENTS ======
    function buildResponseGrid() {
      responseGrid.innerHTML = "";
      for (var i = 0; i < 8; i++) {
        var inp = document.createElement("input");
        inp.type = "text";
        inp.maxLength = 1;
        inp.setAttribute("data-index", i);
        inp.addEventListener("input", function () {
          this.value = this.value.toUpperCase();
        });
        responseGrid.appendChild(inp);
      }
    }

    function buildWorksheetGrid() {
      var html = "<table><thead><tr><th>Row</th>";
      for (var c = 1; c <= 8; c++) {
        html += "<th>" + c + "</th>";
      }
      html += "</tr></thead><tbody>";

      for (var i = 0; i < sequences.length; i++) {
        var row = sequences[i];
        html += "<tr><td class=\"row-label\">" + (i + 1) + "</td>";
        for (var j = 0; j < row.length; j++) {
          var letter = row[j];
          var isRhyming = rhymingLetters.indexOf(letter) !== -1;
          var cellClass = isRhyming ? "rhyming-cell" : "non-rhyming-cell";
          html += "<td class=\"letter-cell " + cellClass + "\">" + letter + "</td>";
        }
        html += "</tr>";
      }

      html += "</tbody></table>";
      worksheetGrid.innerHTML = html;
    }

    buildResponseGrid();
    buildWorksheetGrid();

    // ====== STEP 1 -> STEP 2 ======
    goToStep2Btn.addEventListener("click", function () {
      var exp = Number(exposureInput.value || "0");
      if (!exp || exp <= 0) {
        alert("Please enter a valid exposure time (in seconds).");
        return;
      }
      exposureMs = exp * 1000;
      // Switch sections
      step1.style.display = "none";
      step2.style.display = "block";
      // Scroll up a little so Step 2 is visible
      window.scrollTo(0, 0);
    });

    // ====== BLOCK / TRIAL LOGIC ======
    function startBlock(blockType) {
      var exp = Number(exposureInput.value || "5");
      exposureMs = exp * 1000;

      currentBlock = {
        blockType: blockType,
        startIndex: 0,
        endIndex: sequences.length - 1,
        currentIndex: 0
      };

      worksheetGridContainer.style.display = "block";
      worksheetGridContainer.style.display = "block"; // just in case
      worksheetGridContainer.style.display = "block";
      worksheetGridContainer.style.display = "block";

      // actually hide it
      worksheetGridContainer.style.display = "none";

      setBlockStatus(getBlockName(blockType) + ": Trial 1 of " + sequences.length + ".");
      resetTrialUI();
      runNextTrial();
    }

    function runNextTrial() {
      clearTimer();
      if (!currentBlock) return;

      var idx = currentBlock.currentIndex;
      if (idx > currentBlock.endIndex) {
        sequenceContainer.style.display = "none";
        inputContainer.style.display = "none";
        setBlockStatus(
          getBlockName(currentBlock.blockType) +
          " finished. You can run the other block or go to Step 3."
        );

        worksheetGridContainer.style.display = "block";

        currentBlock = null;
        updateAllSummaries();
        updateTrialTable();

        if (trials.length > 0) {
          step3.style.display = "block";
        }
        return;
      }

      var trialNumberInBlock = idx - currentBlock.startIndex + 1;
      var totalInBlock = currentBlock.endIndex - currentBlock.startIndex + 1;

      setBlockStatus(
        getBlockName(currentBlock.blockType) +
        " – Trial " + trialNumberInBlock + " of " + totalInBlock
      );

      var seq = sequences[idx];
      sequenceDisplay.textContent = seq.join(" ");

      // Eye instruction for this trial
      var rowNumber = idx + 1;
      var eyeInstructionText = "";
      if (currentBlock.blockType === "both_open_block") {
        eyeInstructionText = "Row " + rowNumber + ": Ask the participant to keep BOTH eyes open.";
      } else {
        if (rowNumber % 2 === 1) {
          eyeInstructionText = "Row " + rowNumber + ": Ask the participant to CLOSE their RIGHT eye (left eye open).";
        } else {
          eyeInstructionText = "Row " + rowNumber + ": Ask the participant to CLOSE their LEFT eye (right eye open).";
        }
      }
      eyeInstructionEl.textContent = eyeInstructionText;

      sequenceContainer.style.display = "block";
      inputContainer.style.display = "none";

      timerStatus.textContent = "";
      showingTimeout = setTimeout(function () {
        sequenceContainer.style.display = "none";
        inputContainer.style.display = "block";
        timerStatus.textContent = "Sequence hidden. Ask the participant to type the letters.";
        var firstInput = responseGrid.querySelector("input");
        if (firstInput) firstInput.focus();
      }, exposureMs);
    }

    function eyeConditionForTrial(blockType, rowNumber) {
      if (blockType === "both_open_block") {
        return "both_open";
      }
      return rowNumber % 2 === 1 ? "right_closed" : "left_closed";
    }

    function handleSubmitTrial() {
      if (!currentBlock) {
        alert("No block is currently running.");
        return;
      }

      var inputs = responseGrid.querySelectorAll("input");
      var responses = [];
      var i;
      for (i = 0; i < inputs.length; i++) {
        responses.push((inputs[i].value || "").trim().toUpperCase());
      }

      var anyFilled = false;
      for (i = 0; i < responses.length; i++) {
        if (responses[i] !== "") {
          anyFilled = true;
          break;
        }
      }
      if (!anyFilled) {
        if (!confirm("All response boxes are empty. Submit this trial anyway?")) {
          return;
        }
      }

      var idx = currentBlock.currentIndex;
      var seq = sequences[idx];
      var rowNumber = idx + 1;

      var totalErrors = 0;
      var rhymingErrors = 0;
      var nonRhymingErrors = 0;

      for (i = 0; i < seq.length; i++) {
        var trueLetter = seq[i];
        var respLetter = responses[i] || "";
        var isCorrect = respLetter === trueLetter;
        if (!isCorrect) {
          totalErrors++;
          if (rhymingLetters.indexOf(trueLetter) !== -1) {
            rhymingErrors++;
          } else {
            nonRhymingErrors++;
          }
        }
      }

      var eyeCondCode = eyeConditionForTrial(currentBlock.blockType, rowNumber);
      var trialRecord = {
        participant: participantInput.value || "",
        rowIndex: rowNumber,
        blockType: currentBlock.blockType,
        eyeCondition: eyeCondCode,
        eyeConditionLabel: getEyeConditionLabel(eyeCondCode),
        sequence: seq.join(" "),
        response: responses.join(" "),
        totalErrors: totalErrors,
        rhymingErrors: rhymingErrors,
        nonRhymingErrors: nonRhymingErrors
      };

      trials.push(trialRecord);
      updateAllSummaries();
      updateTrialTable();

      currentBlock.currentIndex++;
      resetTrialUI();
      runNextTrial();
    }

    // ====== RESET ======
    function resetExperiment() {
      if (!confirm("This will clear ALL data and go back to Step 1. Continue?")) return;
      clearTimer();
      currentBlock = null;
      trials = [];
      participantInput.value = "";
      resetTrialUI();
      setBlockStatus("No block running yet.");
      iv1SummaryContainer.innerHTML = "";
      summaryContainer.innerHTML = "";
      trialTableContainer.innerHTML = "";

      worksheetGridContainer.style.display = "block";

      step1.style.display = "block";
      step2.style.display = "none";
      step3.style.display = "none";
      window.scrollTo(0, 0);
    }

    // ====== SUMMARIES ======
    function updateAllSummaries() {
      updateIV1Summary();
      updateIV2Summary();
    }

    // IV1: main effect of phonological similarity – ONLY both eyes open
    function updateIV1Summary() {
      var bothOpenTrials = [];
      for (var i = 0; i < trials.length; i++) {
        if (trials[i].eyeCondition === "both_open") {
          bothOpenTrials.push(trials[i]);
        }
      }

      if (bothOpenTrials.length === 0) {
        iv1SummaryContainer.innerHTML =
          "<p class='small-note'>No data yet. Run Block 1 (both eyes open) first.</p>";
        return;
      }

      var totalRhymingErrors = 0;
      var totalNonRhymingErrors = 0;

      for (i = 0; i < bothOpenTrials.length; i++) {
        totalRhymingErrors    += bothOpenTrials[i].rhymingErrors;
        totalNonRhymingErrors += bothOpenTrials[i].nonRhymingErrors;
      }

      var html = ""
        + "<table>"
        + "<thead><tr>"
        + "<th>Letter type</th>"
        + "<th>Total errors (both eyes open)</th>"
        + "</tr></thead>"
        + "<tbody>"
        + "<tr><td>Rhyming letters</td><td>" + totalRhymingErrors + "</td></tr>"
        + "<tr><td>Non-rhyming letters</td><td>" + totalNonRhymingErrors + "</td></tr>"
        + "</tbody></table>";

      iv1SummaryContainer.innerHTML = html;
    }

    // IV2: eye condition × phonological similarity – all blocks
    function updateIV2Summary() {
      if (trials.length === 0) {
        summaryContainer.innerHTML =
          "<p class='small-note'>No data yet.</p>";
        return;
      }

      var summary = {
        both_open:   { rhymingErrors: 0, nonRhymingErrors: 0 },
        right_closed:{ rhymingErrors: 0, nonRhymingErrors: 0 },
        left_closed: { rhymingErrors: 0, nonRhymingErrors: 0 }
      };

      for (var i = 0; i < trials.length; i++) {
        var t = trials[i];
        summary[t.eyeCondition].rhymingErrors    += t.rhymingErrors;
        summary[t.eyeCondition].nonRhymingErrors += t.nonRhymingErrors;
      }

      var html = ""
        + "<table>"
        + "<thead><tr>"
        + "<th>Eye condition</th>"
        + "<th>Rhyming errors</th>"
        + "<th>Non-rhyming errors</th>"
        + "<th>Total errors</th>"
        + "</tr></thead><tbody>"
        + "<tr><td>Both eyes open</td>"
        + "<td>" + summary.both_open.rhymingErrors + "</td>"
        + "<td>" + summary.both_open.nonRhymingErrors + "</td>"
        + "<td>" + (summary.both_open.rhymingErrors + summary.both_open.nonRhymingErrors) + "</td></tr>"
        + "<tr><td>Right eye closed</td>"
        + "<td>" + summary.right_closed.rhymingErrors + "</td>"
        + "<td>" + summary.right_closed.nonRhymingErrors + "</td>"
        + "<td>" + (summary.right_closed.rhymingErrors + summary.right_closed.nonRhymingErrors) + "</td></tr>"
        + "<tr><td>Left eye closed</td>"
        + "<td>" + summary.left_closed.rhymingErrors + "</td>"
        + "<td>" + summary.left_closed.nonRhymingErrors + "</td>"
        + "<td>" + (summary.left_closed.rhymingErrors + summary.left_closed.nonRhymingErrors) + "</td></tr>"
        + "</tbody></table>";

      summaryContainer.innerHTML = html;
    }

    // Trial table
    function updateTrialTable() {
      if (trials.length === 0) {
        trialTableContainer.innerHTML =
          "<p class='small-note'>No trial data yet.</p>";
        return;
      }

      var html = ""
        + "<table>"
        + "<thead><tr>"
        + "<th>#</th>"
        + "<th>Participant</th>"
        + "<th>Row</th>"
        + "<th>Block</th>"
        + "<th>Eye condition</th>"
        + "<th>Sequence</th>"
        + "<th>Response</th>"
        + "<th>Total errors</th>"
        + "<th>Rhyming errors</th>"
        + "<th>Non-rhyming errors</th>"
        + "</tr></thead><tbody>";

      for (var i = 0; i < trials.length; i++) {
        var t = trials[i];
        html += "<tr>"
          + "<td>" + (i + 1) + "</td>"
          + "<td>" + t.participant + "</td>"
          + "<td>" + t.rowIndex + "</td>"
          + "<td>" + (t.blockType === "both_open_block" ? "Block 1" : "Block 2") + "</td>"
          + "<td>" + t.eyeConditionLabel + "</td>"
          + "<td>" + t.sequence + "</td>"
          + "<td>" + t.response + "</td>"
          + "<td>" + t.totalErrors + "</td>"
          + "<td>" + t.rhymingErrors + "</td>"
          + "<td>" + t.nonRhymingErrors + "</td>"
          + "</tr>";
      }

      html += "</tbody></table>";
      trialTableContainer.innerHTML = html;
    }

    // ====== CSV EXPORT ======
    function downloadCsv() {
      if (trials.length === 0) {
        alert("No data to download yet.");
        return;
      }

      var header = [
        "participant",
        "rowIndex",
        "blockType",
        "eyeConditionCode",
        "eyeConditionLabel",
        "sequence",
        "response",
        "totalErrors",
        "rhymingErrors",
        "nonRhymingErrors"
      ];

      var rows = [header.join(",")];

      for (var i = 0; i < trials.length; i++) {
        var t = trials[i];
        var row = [
          t.participant,
          t.rowIndex,
          t.blockType,
          t.eyeCondition,
          "\"" + t.eyeConditionLabel + "\"",
          "\"" + t.sequence + "\"",
          "\"" + t.response + "\"",
          t.totalErrors,
          t.rhymingErrors,
          t.nonRhymingErrors
        ];
        rows.push(row.join(","));
      }

      var csv = rows.join("\n");
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      var pid = participantInput.value || "data";
      a.download = "phonological_2blocks_data_" + pid + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ====== EVENT LISTENERS ======
    startBothBtn.addEventListener("click",  function () { startBlock("both_open_block"); });
    startAltBtn.addEventListener("click",   function () { startBlock("alt_block"); });
    resetBtn.addEventListener("click",      resetExperiment);
    submitTrialBtn.addEventListener("click", handleSubmitTrial);
    downloadCsvBtn.addEventListener("click", downloadCsv);
  </script>
</body>
</html>
